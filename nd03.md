# ネットワークセキュリティ演習
## 3回 利用者認証／認可とアクセス制御

## 暗号学的ハッシュ関数の実行

nano エディタでメッセージを作成

```
nano message

```


```
hello Kindai people!

[ 新しいファイル ]
^G ヘルプ    ^O 書き込み  ^W 検索      ^K 切り取り  ^J 均等割付  ^C カーソル位置
^X 終了      ^R 読み込み  ^\ 置換      ^U 貼り付け  ^T スペル確認^_ 行を指定
```

保存: コントロールO、 エンターキー

終了：コントロールX

### SHA256によるsampleのハッシュ値の計算

```
sha256sum sample
```

opensslコマンドを使う場合

```
openssl sha256 sample
```

### SHA512によるsampleのハッシュ値の計算

```
sha512sum sample
```

opensslコマンドを使う場合

```
openssl sha512 sample
```

## パスワードファイルの確認

/ect/passwd の内容

```
cat /etc/passwd
```

ユーザ名がkindaiのところを見つける

/etc/shadow の内容の確認

```
sudo cat /etc/shadow
```

ユーザ名がkindaiのところを見つける

grep コマンドを使うとその行だけ見つけてくれる

パイプライン '|' を使うと、前のコマンドの実行結果を次のコマンドの入力にしてくれる

```
sudo cat /etc/shadow |grep kindai

# 結果
kindai:$6$.3zGobdz$5Ouhb1Ntz1z.VIeuNuGCGzR9X0tjQ6d5AdurV/6PrCpGb2M..mod6l5dUtfLDBYx6elFfc4N.wLu3bSsPWfWS/:17812:0:99999:7:::
```

## パスワードクラッカー

/etc/passwdのクラックツール「John The Ripper」を使ってみる

### John the Ripperをインストール

```
sudo apt install john
```

### クラック対象のユーザを作成する

わざと弱いパスワードをつけてみる

```
sudo adduser userx

# パスワードに hydrogen を入れてみる

```

### /etc/shadow を解析可能にする

```
sudo unshadow /etc/passwd /etc/shadow > ~/jpasswd
sudo chmod 400 jpasswd
```

### johnコマンドを実行

ubuntuの辞書ファイルを使ってパスワードを調べる

10分近くかかる

```
john --users=userx --wordlist=/usr/share/dict/words jpasswd
```

発見したパスワードを表示する

```
john --users=userx --show jpasswd

userx:hydrogen:1003:1006:,,,:/home/userx:/bin/bash

1 password hash cracked, 0 left
```


## Rainbow Table

レインボーテーブル無料配布サイトURL

```
https://project-rainbowcrack.com/table.htm

```

## キーロガー

linuxのキーロガーをインストールする

他人が自分のマシンを使った形跡を調べるのにも利用可能

logkeys のインストール

```
sudo apt update
sudo apt upgrade
sudo apt install -y autoconf
sudo apt install -y make
sudo apt install -y gcc
sudo apt install -y git

git init
git clone https://github.com/kernc/logkeys

cd logkeys
./autogen.sh
cd build
../configure
make
sudo make install 
```

USBキーボードのイベント情報をしらべる

```
cat /proc/bus/input/devices
```

出てくる結果の中で、Name= ** USB Keyboad ** というところを調べる

```
I: Bus=0003 Vendor=1c4f Product=0027 Version=0110
N: Name="SIGMACHIP USB Keyboard"
P: Phys=usb-0000:00:14.0-4.2/input0
S: Sysfs=/devices/pci0000:00/0000:00:14.0/usb1/1-4/1-4.2/1-4.2:1.0/0003:1C4F:0027.0002/input/input5
U: Uniq=
H: Handlers=sysrq kbd event5 leds 
B: PROP=0
B: EV=120013
B: KEY=1000000000007 ff800000000007ff febeffdff3cfffff fffffffffffffffe
B: MSC=10
B: LED=7
```

この中の H: のところ

```
Handlers=sysrq kbd event5 leds 
```

の場所をみると event5 になっている
各自のマシンで異なるeventの場合もある

### キーロガーを起動する

最後の event5 は、上記のevetを指定している
各自で異なる場合がある

logtest.txt は、キーボードイベントの記録用ファイル

```
sudo logkeys -s -o ~/logtest.txt -d /dev/input/event5
```

### キーロガーを停止する

停止する前にキーボードを操作しておく


```
sudo logkeys -k
```

### キーのログを確認する

```
sudo cat logtest.txt
```


## シェルスクリプト

### シェルスクリプトとはコマンドを自動実行するファイル

コマンドを実行してみる

```
date
```


簡単なシェルスクリプトをnanoエディタで作成する

date コマンドを実行するシェルスクリプトを jikoku.sh という名前で作成する

```
nano jikoku.sh
```

内容
１行名は、かならず #!/bin/bash

```
#!/bin/bash
date
```

### シェルスクリプトに実行権限を与える

```
chmod 770 jikoku.sh
```

### 作成したシェルスクリプトを実行する

いまこのディレクトリ（カレントディレクトリ）を ./ と書く

```
./jikoku.sh
```

### 200人のユーザをつくる(１)

```
nano add_students.sh
```


```
#!/bin/bash                                                                             
i=1
n=200
while [ $i -le $n ];
do
  echo "gaksei$i"
  i=`expr $i + 1`
done
```

実行権限を与える

```
chmod 770 add_students.sh
```

```
./add_students.sh
```

### 200人の学生ユーザをつくる(2)

```
nano add_students.sh 
```

★useradd -m を使う

```
#!/bin/bash                                                                             
i=1
n=200
while [ $i -le $n ];
do
  echo "gaksei$i"
  sudo useradd -m  "gakusei$i"
  i=`expr $i + 1`
done
```

実行権限を与える

```
chmod 770 add_students.sh
```

```
sudo ./add_students.sh
```

### 200人の学生ユーザとディレクトリを削除する

```
nano del_students.sh

```

```
#!/bin/bash                                                                             
i=1
n=200
while [ $i -le $n ];
do
  echo "gaksei$i"
  userdel -r "gakusei$i"
  i=`expr $i + 1`
done

```

実行権限を与える


```
chmod 770 del_students.sh
```

```
sudo ./del_students.sh
```

### 学生のプライマリグループをstudentにする

再度ユーザ作成

```
./add_students.sh
```

```
nano mod_students.sh
```

```
#!/bin/bash                                                                             
i=1
n=200
while [ $i -le $n ];
do
  echo "gakusei$i"
  sudo usermod -g student "gakusei$i" 
  i=`expr $i + 1`
done
```

```
sudo chmod 770 mod_students.sh
./mod_students.sh
```
### 最初の100人の学生を情報学科グループに

```
sudo groupadd joho
```

```
nano joho_students.sh
```

```
#!/bin/bash                                                                             
i=1
n=100
while [ $i -le $n ];
do
  echo "gakusei$i"
  sudo usermod -G joho "gakusei$i" 
  i=`expr $i + 1`
done

```

実行権限を与える

```
chmod 770 joho_students.sh
```

```
./joho_students.sh
```


### 情報学科の２0人を「情報エンジニア」の履修生に

```
groupadd engineer
```

```
nano eng_students.sh

```

```
#!/bin/bash                                                                             
i=1
n=20
while [ $i -le $n ];
do
  sudo usermod -G joho, engineer "gakusei$i" 
  i=`expr $i + 1`
done
```

実行権限を与える

```
chmod 770 eng_students.sh
```

```
./nstudents.sh
```

### 情報学科の学生と教員のみがアクセスできるディレクトリを作成

演習用ディレクトリ作成

```
mkdir /tmp/enshu2/
```

情報学科用ディレクトリ作成

```
mkdir /tmp/enshu2/joho
```

情報学科学生用ディレクトリ作成

```
mkdir /tmp/enshu2/joho/students
```




